#!/usr/bin/perl -w

use strict;


my $dataDir = "$ENV{HOME}/.local/share/tagit";
my $itemDir = "$dataDir/items";
my $dbName = "$dataDir/base.sqlite";


# 1) tagit tag file1 [file2...] -t tag1[,tag2...]
# 2) tagit describe filename
# 3) tagit show tag
# 4) TODO: tagit search term
# 5) TODO: add VCS suport
# 6) TODO: add URL handling: retrieve, store & tag page

use DBI;
use Digest::MD5::File qw(file_md5_hex);
use File::Spec;
use File::Copy;
use Getopt::Long;


my $base="dbi:SQLite:dbname=$dbName";
my $dbh = DBI->connect($base,"","");





parseArgs();




sub parseArgs{
	my $cmd;
	unless (@ARGV) {
		$cmd = 'help';
	}
	else {
		$cmd = $ARGV[0];
		shift @ARGV;
	}
	if ($cmd eq 'tag') {
		my @tags;
		GetOptions('tags=s{1,1000}' => \@tags);
		foreach my $file (@ARGV) {
		#tag file
		unless (-f $file) {
			print STDERR "tagit: Not found or is not palin file: $file\n";
			exit 1;
		}
		tag(File::Spec->rel2abs($file), @tags);
#			print "args:  @tags \nARGV:@ARGV\n";
		}
	}
}












sub tag {
	my $file = shift;
	my @tags = @_;
	my $oid;

#	create date-named dir
	my @times = localtime;
	$times[5] += 1900;
	my $dirName = "$itemDir/$times[5]-$times[4]-$times[3]";
	mkdir $dirName;

# split filename to parts
	my ($vol, $path, $fName) = File::Spec->splitpath($file);

#	compute md5
my $md5 = file_md5_hex($file);

my $sth = $dbh->prepare("SELECT oid FROM objects WHERE md5=?");
unless ($sth->execute($md5)) {
	return -2;	#bad SQL
};

if ($oid = $sth->fetchrow_array()) {
	return -3;	#already exists
}

#	hardlink file into this dir. If different filesystems - copy
	if (!link $file, "$dirName/$md5") {
	# cannot create hardlink, so we need copy
		my $result = copy $file, "$dirName/$md5";
		#if we cannot copy, abort
		return -1 unless ($result);
	}
	$dbh->do("BEGIN TRANSACTION");
#	store in db: did	md5	external_filename	add_time
	$sth = $dbh->prepare("INSERT INTO objects (md5, source, date) VALUES (?, ?, ?)");
	my $time = time;
	unless ($sth->execute($md5, $file, $time)) {
		# cannot insert may be, file already exists?
		
	}	
	$oid = $dbh->func('last_insert_rowid');
	my @tids;
	my $tid;
	foreach my $tag (@tags) {
		$sth = $dbh->prepare("INSERT INTO tags (name) VALUES (?)");
		unless ($sth->execute($tag)) {
			$sth = $dbh->prepare("SELECT tid FROM tags WHERE name=?");
			unless ($sth->execute($tag)) {
				$dbh->do("ROLLBACK TRANSACTION");
				return -3;
			}
			unless ($tid = $sth->fetchrow_array()) {
				$dbh->do("ROLLBACK TRANSACTION");
				return -3;
			}
		} else {
			$tid = $dbh->func('last_insert_rowid');
		}
		push @tids, $tid;

	}
#	store in db for each new tag: tid	tagname;	did	tid
	
	foreach $tid (@tids) {
		$sth = $dbh->prepare("INSERT INTO links (oid, tid) VALUES (?, ?)");
			unless ($sth->execute($oid, $tid)) {
				$dbh->do("ROLLBACK TRANSACTION");
				return -3;
			}
	}
	$dbh->do("COMMIT TRANSACTION");
	


}
